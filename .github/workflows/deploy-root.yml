name: Deploy Backend to VPS

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "temurin"
          cache: "maven"

      - name: Build with Maven
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Deploy with Docker Compose
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$REMOTE_HOST" >> ~/.ssh/known_hosts

          ssh -i ~/.ssh/deploy_key "$REMOTE_USER@$REMOTE_HOST" "rm -f /root/*.jar"

          scp -i ~/.ssh/deploy_key backend/target/*.jar docker-compose.deploy.yml "$REMOTE_USER@$REMOTE_HOST":/root/

          ssh -i ~/.ssh/deploy_key "$REMOTE_USER@$REMOTE_HOST" << 'EOF'
            cd /root
            latest_jar=$(ls -t *.jar | head -1)
            if [ -n "$latest_jar" ]; then
              mv "$latest_jar" app.jar
              docker compose -f docker-compose.deploy.yml down
              docker compose -f docker-compose.deploy.yml up -d --build
            else
              echo "Error: No jar file found after SCP!"
              exit 1
            fi
          EOF
